---
title: JavaScript 模版引擎
date: 2017-06-27
---
# JavaScript 模版引擎

> JavaScript 模板引擎就是：结合内容数据，把带有 `内容标识` 的 `伪HTML` 语句翻译为 `HTML` 的苦力。

<!-- more -->

### 1、组成

模板引擎一般由以下几部分组成：**语法、解析、编译、缓存、渲染。**

* 语法

    * 定义模板的书写方式——模板引擎可解析的格式
    * 模板系统一般会有一套自己的模板语法，但通常是非常简单的，大致包含：
        * **变量** 普通字符串、转义字符串等，只用于普通替换
        * **逻辑** if + else、for（list）、include（import）等一些需要根据数据去实时改变展示的逻辑
    
* 解析

    * 词法分析（scanning）和语义分析（parsing），一般包括 **data- 配置、正则解析转义** 等

* 编译

    * 将原始的模板字符串转换成一个函数对象（为了使模板能够与数据一起执行生成字符串）

* 缓存

    * 用于提升性能，一般包括 **缓存编译结果（函数）** 或者 **缓存渲染过程中涉及的数据（查找结果，字符串）**，也称之为预编译

* 渲染
    * 执行编译结果，生成 HTML 结构

***

### 2、简单实现

先用一张图直观来看下模板引擎的工作过程：

![](https://ooo.0o0.ooo/2017/06/26/5950f2e7319d7.jpg)

模板引擎就是利用正则表达式识别模板标识，并利用数据替换其中的标识符。

* 2.1 解析、字符串替换

`Hello, <%=name%>` + {name: 'ReAlign'} ==>  `Hello, ReAlign`

![](https://ooo.0o0.ooo/2017/06/26/5950f3260d52c.jpg)

[字符串替换的DEMO](https://codepen.io/realign/pen/yXzEwM)

* 2.2 编译

为了能够与数据一起执行生成字符串，我们需要将原始的模板字符串转换成一个函数对象。这个过程称为模板编译。模板编译使用了new Function(), 这里通过它创建了一个函数对象:

![](https://ooo.0o0.ooo/2017/06/26/5950f2ec2dcff.jpg)

[编译的DEMO](https://codepen.io/realign/pen/mwBGaX)

* 2.3 预编译

模板编译过程中每次都要new Function()重新生成一个函数，这显然不是我们要的。我们可以将函数缓存起来，避免重复生成：

![](https://ooo.0o0.ooo/2017/06/26/5950f2ed62046.jpg)

[预编译的DEMO](https://codepen.io/realign/pen/dRVqLz)

* 2.4 简单逻辑实现

一般常见的模板引擎，都允许在模板中添加一部分逻辑来渲染页面，代表的逻辑标识和内容标识需要在形式上加以区分：

* <%...%>  逻辑标识
* <%=...%> 内容标识

![](https://ooo.0o0.ooo/2017/06/26/595111b31df3a.jpg)

[简单逻辑的DEMO](https://codepen.io/realign/pen/OgxazR)

***

上面说了那么多，那么，问题来了：什么时候使用 JavaScript 模板？

* JavaScript 代码内含有 HTML
* HTML 结构依赖数据
* 重复的 HTML

当你的代码有上述的一点或者几点时，就应该开始考虑使用 JavaScript 模板了。

**前端开发，将 HTML 从 JavaScript 分离很重要，而在 HTML 中不内联 JavaScript 同样重要。**

***

上面的实现只是非常简单的，算不上模板引擎，只能算是简易模板。模板引擎是一个系统的问题，复杂模板还支持模板嵌套、模板导入、模板注释以及强大的容错和debug处理等。。。

by ReAlign


